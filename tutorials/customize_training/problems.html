
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Adaptive Stress Testing for Robust AI & Reinforcement Learning — a toolbox for testing and improving the robustness of AI systems.">
      
      
        <meta name="author" content="Duncan Eddy">
      
      
        <link rel="canonical" href="https://github.com/sisl/astra-rl/tutorials/customize_training/problems.html">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>How to Create a Custom Problem Class for Red-Teaming with ASTRA-RL - ASTRA-RL Toolbox Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="black">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-create-a-custom-problem-class-for-red-teaming-with-astra-rl" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="ASTRA-RL Toolbox Documentation" class="md-header__button md-logo" aria-label="ASTRA-RL Toolbox Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ASTRA-RL Toolbox Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How to Create a Custom Problem Class for Red-Teaming with ASTRA-RL
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="black"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="black"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/sisl/astra-rl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../index.html" class="md-tabs__link">
        
  
  
    
  
  ASTRA

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
  
    
  
  Tutorials

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../api/index.html" class="md-tabs__link">
        
  
  
    
  
  Library API Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="ASTRA-RL Toolbox Documentation" class="md-nav__button md-logo" aria-label="ASTRA-RL Toolbox Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ASTRA-RL Toolbox Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/sisl/astra-rl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ASTRA
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../index.html" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../training_an_evaluator.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Training an Evaluator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../running_an_evaluation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running An Evaluation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Library API Reference
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#understanding-the-base-class" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding the Base Class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-create-a-subclass-with-custom-modelstokenizers" class="md-nav__link">
    <span class="md-ellipsis">
      How to create a subclass with custom models/tokenizers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-integrating-your-own-models-attacker-target-or-baseline" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Integrating Your Own Models (Attacker, Target, or Baseline)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-customizing-rollout-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Customizing Rollout Logic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-5-customizing-reward-logic" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Customizing Reward Logic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tips-and-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Tips and Best Practices:
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading-and-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Further Reading and Examples
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="how-to-create-a-custom-problem-class-for-red-teaming-with-astra-rl">How to Create a Custom Problem Class for Red-Teaming with ASTRA-RL<a class="headerlink" href="#how-to-create-a-custom-problem-class-for-red-teaming-with-astra-rl" title="Permanent link">&para;</a></h1>
<p>The <code>Problem</code> class defines the core logic of how attacker-target interactions occur in reinforcement-learning-based red-teaming. It specifies:</p>
<ul>
<li>How the attacker and target interact and advance the conversation state.</li>
<li>How reward signals are computed from attacker-target interactions.</li>
<li>How a model rollout step is performed.</li>
<li>What models and tokenizers are used for attacker, target, and baseline (if applicable).</li>
</ul>
<p>By subclassing the <code>Problem</code> or <code>ASTProblem</code> class, you can customize any of these aspects to fit your particular red-teaming scenario, algorithm, or dataset. In general, we reccomend subclassing from the ASTProblem or HFASTProblem whenever you can and then over-writing methods or definitions to suite your needs. </p>
<p>This guide will show you how to:</p>
<ul>
<li>Create your own custom subclass.</li>
<li>Integrate your own models and tokenizers.</li>
<li>Customize reward computation and rollout logic.</li>
</ul>
<hr />
<h2 id="understanding-the-base-class">Understanding the Base Class<a class="headerlink" href="#understanding-the-base-class" title="Permanent link">&para;</a></h2>
<p>The base <code>ASTProblem</code> (source code astra-rl/src/astra_rl/methods/ast_problem.py) class provides default implementations 
suitable for the ASTPrompter approach:</p>
<ul>
<li><strong><code>advance</code></strong>: Defines how a prompt advances given an attacker action and a target response.</li>
<li><strong><code>reward</code></strong>: Defines how rewards are calculated from attacker-target interactions, using toxicity scoring and perplexity measures.</li>
<li><strong><code>rollout_prompt_with_attacker</code> / <code>rollout_prompt_with_target</code></strong>: Methods to generate attacker and target model outputs from a given context.</li>
<li><strong><code>parameters</code></strong>: Specifies model parameters for optimization.</li>
</ul>
<p>If possible, you should subclass this base class to preserve and extend this default behavior. If you want to change a method, simply define it in your subclass and it will over-right the original implementation while preserving the rest of the base class functionality.</p>
<hr />
<h2 id="how-to-create-a-subclass-with-custom-modelstokenizers">How to create a subclass with custom models/tokenizers<a class="headerlink" href="#how-to-create-a-subclass-with-custom-modelstokenizers" title="Permanent link">&para;</a></h2>
<p>To subclass your own <code>Problem</code>, follow this template:</p>
<pre><code class="language-python">from astra_rl.methods.ast_problem import ASTProblem
from astra_rl.core.moderator import Moderator

class MyCustomProblem(ASTProblem):
    def __init__(self, moderator: Moderator[str, str], my_custom_param: float = 1.0):
        super().__init__(moderator)
        self.my_custom_param = my_custom_param

    def advance(self, state: str, action: str, response: str) -&gt; str:
        # Example: Simply concatenate with separators
        return f&quot;{state}\n[Attacker]: {action}\n[Target]: {response}&quot;

    def reward(self, contexts, attacks, responses):
        # Implement your own reward logic here
        scores = self.moderator.moderate(responses)
        return [score * self.my_custom_param for score in scores]

    def rollout_prompt_with_attacker(self, prompts):
        # Implement custom attacker rollout logic
        raise NotImplementedError

    def rollout_prompt_with_target(self, prompts):
        # Implement custom target rollout logic
        raise NotImplementedError

    def parameters(self):
        # Implement if your problem has trainable model parameters
        return []
</code></pre>
<hr />
<h2 id="step-3-integrating-your-own-models-attacker-target-or-baseline">Step 3: Integrating Your Own Models (Attacker, Target, or Baseline)<a class="headerlink" href="#step-3-integrating-your-own-models-attacker-target-or-baseline" title="Permanent link">&para;</a></h2>
<p>If you are using huggingface models, save time by subclassing from our HFASTProblem base class which takes in any huggingface model names for the attacker, target, and baseline. However, you can also integrate any pretrained language model by loading the model and tokenizer in your constructor. If you integrate your own custom model, you must ensure that the corresponding rollout method(s) (rollout_prompt_with_(MODEL) more info below) and the corresponding (.get_(MODEL)_logprobs) method(s) are updated to correctly integrate your custom model.
Here's how to do it clearly and correctly:</p>
<pre><code class="language-python">from transformers import AutoModelForCausalLM, AutoTokenizer
import torch

# Create your subclass from the base Problem (most bare-boned) or the base ASTPrompter class (takes care of rollout and log probability methods)
class MyHuggingFaceProblem(ASTProblem):
    def __init__(self, attacker_model_id: str, target_model_id: str, moderator, device=&quot;cuda&quot;):
        super().__init__(moderator)
        self.device = device

        # Load your custom models and tokenizers
        self.attacker = AutoModelForCausalLM.from_pretrained(attacker_model_id).to(self.device)
        self.attacker_tokenizer = AutoTokenizer.from_pretrained(attacker_model_id)

        self.target = AutoModelForCausalLM.from_pretrained(target_model_id).to(self.device)
        self.target_tokenizer = AutoTokenizer.from_pretrained(target_model_id)

    # required method to perform one step of a rollout in a batched manner: must take in a state (eg. conversation so far) and return a list of continuations (attacker utterances) in the corresponding order
    def rollout_prompt_with_attacker(self, prompts):
        inputs = self.attacker_tokenizer(prompts, return_tensors=&quot;pt&quot;, padding=True).to(self.device)
        outputs = self.attacker.generate(**inputs, max_new_tokens=32)
        generated_texts = self.attacker_tokenizer.batch_decode(outputs, skip_special_tokens=True)
        continuations = [gen[len(prompt):] for prompt, gen in zip(prompts, generated_texts)]
        return continuations

    def rollout_prompt_with_target(self, prompts):
        inputs = self.target_tokenizer(prompts, return_tensors=&quot;pt&quot;, padding=True).to(self.device)
        outputs = self.target.generate(**inputs, max_new_tokens=32)
        generated_texts = self.target_tokenizer.batch_decode(outputs, skip_special_tokens=True)
        continuations = [gen[len(prompt):] for prompt, gen in zip(prompts, generated_texts)]
        return continuations

    def parameters(self):
        return self.attacker.parameters()
</code></pre>
<hr />
<h2 id="step-4-customizing-rollout-logic">Step 4: Customizing Rollout Logic<a class="headerlink" href="#step-4-customizing-rollout-logic" title="Permanent link">&para;</a></h2>
<p>To customize how attacker-target rollouts are performed, override these methods clearly:</p>
<p>rollout_prompt_with_attacker(prompts: Sequence[str]) → Sequence[str]</p>
<p>rollout_prompt_with_target(prompts: Sequence[str]) → Sequence[str]</p>
<p>For example, you might use sampling strategies, temperature adjustments, or custom stopping criteria:</p>
<pre><code class="language-python">def rollout_prompt_with_attacker(self, prompts):
    inputs = self.attacker_tokenizer(prompts, padding=True, return_tensors=&quot;pt&quot;).to(self.device)
    outputs = self.attacker.generate(
        **inputs,
        do_sample=True,
        max_new_tokens=50,
        temperature=0.8,
        top_k=50,
        top_p=0.9
    )
    texts = self.attacker_tokenizer.batch_decode(outputs, skip_special_tokens=True)
    return [text[len(prompt):] for prompt, text in zip(prompts, texts)]
</code></pre>
<hr />
<h2 id="step-5-customizing-reward-logic">Step 5: Customizing Reward Logic<a class="headerlink" href="#step-5-customizing-reward-logic" title="Permanent link">&para;</a></h2>
<p>Override the reward method to compute your custom reward signal. Typically, you'll combine toxicity, relevance, perplexity, or other metrics:</p>
<pre><code class="language-python">def reward(self, contexts, attacks, responses):
    attack_scores = self.moderator.moderate(attacks)
    response_scores = self.moderator.moderate(responses)
    combined = [(a_score + r_score) / 2.0 for a_score, r_score in zip(attack_scores, response_scores)]
    return combined

</code></pre>
<h2 id="tips-and-best-practices">Tips and Best Practices:<a class="headerlink" href="#tips-and-best-practices" title="Permanent link">&para;</a></h2>
<p>Always clearly document parameters and logic for your custom problem class.</p>
<p>Ensure models and tokenizers are device-aware (e.g., GPU-compatible).</p>
<p>Thoroughly test your rollouts independently before integrating them into the full RL loop.</p>
<p>For debugging, add verbose logging to track input-output sequences.</p>
<h2 id="further-reading-and-examples">Further Reading and Examples<a class="headerlink" href="#further-reading-and-examples" title="Permanent link">&para;</a></h2>
<p>Default ASTPrompter implementation: ASTProblem</p>
<p>HuggingFace-compatible subclass example: HFASTProblem</p>
<p>Environment customization guide: Custom Environments</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="August 19, 2025 07:51:45 UTC">2025-08-19</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="July 2, 2025 05:35:39 UTC">2025-07-02</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "toc.follow"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>